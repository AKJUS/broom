#' Tidying methods for spatially autoregressive models
#'
#' These methods tidy the coefficients of spatial autoregression
#' models generated by functions of the `spatialreg` package.
#'
#' @param x An object of object returned from [spatialreg::lagsarlm()] or [spatialreg::errorsarlm()].
#' @template param_confint
#' @template param_unused_dots
#' 
#' @examples 
#' library(spatialreg)
#' data(oldcol, package="spdep")
#' listw <- spdep::nb2listw(COL.nb, style="W")
#' 
#' crime_sar <- lagsarlm(CRIME ~ INC + HOVAL, data=COL.OLD,  
#'   listw=listw, method="eigen")
#'   
#' tidy(crime_sar)
#' tidy(crime_sar, conf.int = TRUE)
#' 
#' crime_sem <- errorsarlm(CRIME ~ INC + HOVAL, data=COL.OLD, listw)
#' 
#' tidy(crime_sem)
#' tidy(crime_sem, conf.int = TRUE)
#'
#' 
#' @aliases spdep_tidiers
#' @export
#' @family spdep tidiers
#' @seealso [tidy()], [spatialreg::lagsarlm()]
tidy.sarlm <- function(x, conf.int = FALSE, conf.level = .95, ...) {
  # construct parameter table
  s <- summary(x)
  ret <- as_tibble(s$Coef, rownames = 'term')
  colnames(ret) <- c("term", "estimate", "std.error", "statistic", "p.value")
  
  # append spatial autoregression coefficient to parameter table
  if (!is.null(s$rho) == T) {
    # if SAR model, get rho and append to table
    ret2 <- tibble(
        term = "rho",
        estimate = as.numeric(s$rho),
        std.error = as.numeric(s$rho.se),
        statistic = as.numeric(estimate / std.error),
        p.value = as.numeric(2 * (1 - pnorm( abs(statistic) ) ) )
      )
    ret = rbind(ret, ret2)
  } else if (!is.null(s$lambda))  {
    # if SEM model, get lambda and append to table
    ret2 <- tibble(
      term = "lambda",
      estimate = as.numeric(s$lambda),
      std.error = as.numeric(s$lambda.se),
      statistic = as.numeric(estimate / std.error),
      p.value = as.numeric(2 * (1 - pnorm( abs(statistic) ) ) )
    )
    colnames(ret2) <- c("term", "estimate", "std.error", "statistic", "p.value")
    ret = rbind(ret, ret2)
  }
  
  
  # Calculate confidence interval
  if (conf.int) {
    ci <- confint(x, level = conf.level)
    ci <- as_tibble(ci, rownames = "term")
    colnames(ci) <- c("term", "conf.low", "conf.high")
    ret <- dplyr::left_join(ret, ci, by = "term")
  }
  
  
  
  ret
  
}

